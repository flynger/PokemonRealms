<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
    <script>
        window.onload = async () => {
            let rightPressed = false;
            let leftPressed = false;
            let upPressed = false;
            let downPressed = false;
            function keyDownHandler(event) {
                if (event.keyCode === 39) {
                    rightPressed = true;
                } else if (event.keyCode === 37) {
                    leftPressed = true;
                }
                if (event.keyCode === 40) {
                    downPressed = true;
                } else if (event.keyCode === 38) {
                    upPressed = true;
                }
            }
            function keyUpHandler(event) {
                if (event.keyCode === 39) {
                    rightPressed = false;
                } else if (event.keyCode === 37) {
                    leftPressed = false;
                }
                if (event.keyCode === 40) {
                    downPressed = false;
                } else if (event.keyCode === 38) {
                    upPressed = false;
                }
            }
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);
            const app = new PIXI.Application(
                {
                    width: 640,
                    height: 360,
                    backgroundColor: 0x333333
                }
            );
            let player = {
                skin: "red",
                sprite: null,
                // sprite: PIXI.Sprite.from('res/characters/blue.gif'),
                target: {
                    x: 0,
                    y: 0
                },
                speed: 4,
                moving: false,
                sheet: {}
            }
            document.body.appendChild(app.view);
            PIXI.Assets.add("red", "res/characters/red_walk.png");
            PIXI.Assets.add("blue", "res/characters/blue_walk.png");
            const textures = await PIXI.Assets.load(['red', 'blue']).then(loadingComplete);
            console.log(textures);
            function loadingComplete(e) {
                createPlayerSheet();
                app.ticker.add(draw);
            }
            async function createPlayerSheet() {
                let w = 32;
                let h = 48;
                let spritesheetData = {
                    frames: {
                        "red1":
                        {
                            "frame": { "x": 0, "y": 0, "w": 32, "h": 48 },
                            "spriteSourceSize": { "x": 0, "y": 0, "w": 32, "h": 48 },
                            "sourceSize": { "w": 32, "h": 48 }
                        },
                        "red2":
                        {
                            "frame": { "x": 32, "y": 0, "w": 32, "h": 48 },
                            "spriteSourceSize": { "x": 0, "y": 0, "w": 32, "h": 48 },
                            "sourceSize": { "w": 32, "h": 48 }
                        },
                        "red3":
                        {
                            "frame": { "x": 64, "y": 0, "w": 32, "h": 48 },
                            "spriteSourceSize": { "x": 0, "y": 0, "w": 32, "h": 48 },
                            "sourceSize": { "w": 32, "h": 48 }
                        },
                    },

                    "animations": {
                        "walk": ["red1", "red2"]
                    },

                    "meta": {
                        "image": "res/characters/red_walk.png",
                        "format": "RGBA8888",
                        "size": { "w": 128, "h": 192 },
                        "scale": "1"
                    }
                }
                const spritesheet = new PIXI.Spritesheet(
                    PIXI.BaseTexture.from(spritesheetData.meta.image),
                    spritesheetData
                );
                await spritesheet.parse();

                player.sprite = new PIXI.AnimatedSprite(spritesheet.animations.walk);
                player.sprite.animationSpeed = 0.1;
                player.sprite.loop = true;
                app.stage.addChild(player.sprite);
                player.sprite.play();
            }
            function draw(delta) {
                if (!player.moving) {
                    // if player not moving get input
                    if (rightPressed) {
                        player.textures = player.sheet.lookRight;
                        player.moving = true;
                        player.target.x = player.sprite.x + 32;
                        player.target.y = player.sprite.y;
                    } else if (leftPressed) {
                        player.moving = true;
                        player.target.x = player.sprite.x - 32;
                        player.target.y = player.sprite.y;
                    } else if (downPressed) {
                        player.moving = true;
                        player.target.x = player.sprite.x;
                        player.target.y = player.sprite.y + 32;
                    } else if (upPressed) {
                        player.moving = true;
                        player.target.x = player.sprite.x;
                        player.target.y = player.sprite.y - 32;
                    }
                } else {
                    // else move player toward target tile
                    var distX = player.target.x - player.sprite.x;
                    var distY = player.target.y - player.sprite.y;
                    var dx = Math.sign(distX) * player.speed;
                    var dy = Math.sign(distY) * player.speed;
                    if ((!player.idle && (Math.abs(distX) <= player.speed && Math.abs(distY) == 0) || (Math.abs(distY) <= player.speed && Math.abs(distX) == 0)) || player.idleCounter == 0) { // <= or == which one?
                        // if (this.parent.idleCounter == 0) {
                        //     this.target.x = this.parent.idleX;
                        //     this.target.y = this.parent.idleY;
                        //     this.pos.x = this.parent.idleX;
                        //     this.pos.y = this.parent.idleY;
                        //     this.speed = 120 / playerData.FPS;
                        //     this.parent.idle = false;
                        //     this.parent.idleCounter = 8 * playerData.FPS / 30;
                        // } else {
                        player.sprite.x = player.target.x;
                        player.sprite.y = player.target.y;
                        // }
                        // if (this.img.cellX % 2 == 1) this.img.shiftX(1);
                        player.moving = false;
                        // this.canMove = !warpCheck(this.pos.x, this.pos.y);
                    } else {
                        if (!player.idle) {
                            player.sprite.x += dx;
                            player.sprite.y += dy;
                        } else {
                            // if (this.parent.idleCounter == 8 * playerData.FPS / 30) {
                            //     playerData.sounds.bump.setVolume(0.1);
                            //     playerData.sounds.bump.play();
                            // }
                            //console.log(this.parent.idle);
                            //player.idleCounter--;
                        }
                    }
                }
            }
        }
    </script>
</head>

<body>
    <!-- <nav class="navbar navbar-expand-lg navbar-light bg-dark">
        <a class="navbar-brand" href="#"><img src="res/"></a>

    </nav> -->
</body>

</html>